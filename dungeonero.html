<div style="display:flex; justify-content:center; flex-direction:column; padding:5px; border:4px solid black; position:absolute; top:20px; right:10px; background-color:white; z-index:999">
<input type="text" id="filledColor"></input> <button onclick="changeFColor()" style="margin-bottom:15px;">Change filled</button>
<input type="text" id="emptyColor"></input> <button onclick="changeEColor()" style="margin-bottom:15px;">Change empty</button>
<input type="text" id="strokeColor"></input> <button onclick="changeSColor()" style="margin-bottom:15px;">Change stroke</button>
<input type="text" id="backgroundColor"></input> <button onclick="changeBColor()" style="margin-bottom:15px;">Change background</button>
<input type="text" id="gridColor"></input> <button onclick="changeGColor()" style="margin-bottom:15px;">Change grid</button>
</br>
</br>
<div>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="empty" id="interesado" checked> <label for="interesado">Vaciar</label> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="fill" id="indeciso"> <label for="indeciso">Rellenar</label> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="key" id="key"> <label for="key">Clave</label><input type="number" style="margin-left:15px; width:60px;" id="dungeonKey"></input> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="door" id="door"> <label for="door">Puerta</label> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="window" id="window"> <label for="window">Ventana</label> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="sdoor" id="sdoor"> <label for="sdoor">Puerta S.</label> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="trap" id="trap"> <label for="trap">Trampa</label> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="stair" id="stair"> <label for="stair">Escalera</label> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="column" id="column"> <label for="column">Columna</label> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="wall" id="wall"> <label for="wall">Muro</label> </br>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="eraser" id="eraser"> <label for="eraser">Eraser...</label> </br>
<div id="subEraser" style="display:none; margin-left:20px">
	<input checked type="radio" name="subEraser" value="big" id="big"> <label for="big">Big</label> </br>
	<input type="radio" name="subEraser" value="small" id="small"> <label for="small">Small</label> </br>
	<input type="radio" name="subEraser" value="object" id="object"> <label for="object">Object</label> </br>
	<input type="radio" name="subEraser" value="dungeon" id="dungeon"> <label for="dungeon">Dungeon</label> </br>
</div>
<input onclick="changeTool(this.value)" type="radio" name="mode" value="token" id="token"> <label for="token">Tokens...</label> </br>
<div id="subTokens" style="display:none">
	<input type="radio" name="subTokens" value="0" id="t0" style="margin-left:20px" checked> <label for="t0">T0</label> <input type="text" style="margin-left:15px; width:25px;" id="t0T" value="G" maxlength="1"></input> </br>
	<input type="radio" name="subTokens" value="1" id="t1" style="margin-left:20px"> <label for="t1">T1</label> <input type="text" style="margin-left:15px; width:25px;" id="t1T" value="E" maxlength="1"></input> </br>
	<input type="radio" name="subTokens" value="2" id="t2" style="margin-left:20px"> <label for="t2">T2</label> <input type="text" style="margin-left:15px; width:25px;" id="t2T" value="T" maxlength="1"></input> </br>
	<input type="radio" name="subTokens" value="3" id="t3" style="margin-left:20px"> <label for="t3">T3</label> <input type="text" style="margin-left:15px; width:25px;" id="t3T" value="R" maxlength="1"></input> </br>
</div>
</div>
</br>
</br>
<button onclick="ToggleGrid()">Toggle Grid</button>
<button onclick="ToggleGridLines()">Toggle Grid Lines</button>
<button onclick="exporter()">Export</button>
<button onclick="importerButton()">Import</button>
<button onclick="download()">Download</button>
<button onclick="undo()">Undo</button>
</div>

<canvas id="dungeonC" width="1024px" height="1024px" style="position:absolute; top:10px; left:10px; border:3px solid black">

</canvas>

<canvas id="objects" width="1024px" height="1024px" style="position:absolute; top:10px; left:10px; border:3px solid black">

</canvas>

<canvas id="casillero" width="1024px" height="1024px" style="opacity:0.8; display:none; position:absolute; top:10px; left:10px; border:3px solid black">

</canvas>

<canvas id="tokensCanvas" width="1024px" height="1024px" style="opacity:0.8; position:absolute; top:10px; left:10px; border:3px solid black">

</canvas>

<canvas id="cuadraditos" width="1024px" height="1024px" style="opacity:0.8; position:absolute; top:10px; left:10px; border:3px solid black">

</canvas>


<script type="text/javascript" language="javascript">

// Box width
var bw = 1024;
// Box height
var bh = 1024;
// Numero de casillas de ancho
var numCasX = 32;
// Numero de casillas de alto
var numCasY = 32;
// Pixels por casilla de lado
var pxCas = 32;

var click = false;

var selectedTool = "empty";



// Undo function
// ----------------------
var undoArray = new Array();
var undoDungeon = new Array();
var undoObjects = new Array();


// Colors
//------------------------
var backgroundColor = "white";
var strokeColor = "black";
var emptyColor = "lightgray";
var filledColor = "darkgray";
var gridColor = "lightblue";

// Settings
//------------------------
var middleDots = true;
var radioChanger = document.querySelector('input[name="mode"]:checked');
var showGridLine = true;



// Canvas handlers
//-------------------------
var elCasillero = document.getElementById("casillero");
var laDungeon = document.getElementById("dungeonC");
var cuadraditos = document.getElementById("cuadraditos");
var objectC = document.getElementById("objects");

var contextDungeon = laDungeon.getContext("2d");
var contextCasillero = elCasillero.getContext("2d");
var contextCuadraditos = cuadraditos.getContext("2d");
var contextObject = objectC.getContext("2d");
var contextToken = document.getElementById("tokensCanvas").getContext("2d");


// Contenido de casillas
//----------------------
// 1: puerta
// 2: puerta secreta
// 3: muro
// 4: trampa
// 5: columna
// 6: ventana
//-----------------------
var dungeonFilled = {};
var dungeonObject = {};

contextDungeon.fillStyle = filledColor;

for (var x = 0; x < numCasX; x ++) {
	for (var y = 0; y < numCasY; y ++) {
		var aider = [x,y];
	        dungeonFilled[aider] = false;
		contextDungeon.fillRect(x*32,y*32, 32, 32);
    }
}
for (var x = 0; x < numCasX; x ++) {
	for (var y = 0; y < numCasY; y ++) {
		var aider = [x,y];
        dungeonObject[aider] = 0;
    }
}

var casillaSeleccionada;


// Token: [nombre, color, casilla, activo]
var tokens = new Array(  {name:"G", color:"blue", casilla:null, activo:false},
											{name:"E", color:"red", casilla:null, activo:false},
											{name:"T", color:"yellow", casilla:null, activo:false},
											{name:"R", color:"green", casilla:null, activo:false}
										);


// Cargar Dungeon
//----------------------------
function cargarDungeon(){
	contextDungeon.clearRect(0, 0, dungeon.width, dungeon.height);
	contextObject.clearRect(0, 0, dungeon.width, dungeon.height);
	for (var x = 0; x < numCasX; x += 0.5) {
		for (var y = 0; y < numCasY; y+= 0.5) {
			var aider = [x,y];
			casillaSeleccionada = aider;
			if(!isBorderX() && !isBorderY()){
				if(dungeonFilled[aider]){
					pintarCasilla(contextDungeon, casillaSeleccionada, emptyColor);
					dungeonFilled[casillaSeleccionada]=true;

				}else{
					pintarCasilla(contextDungeon, casillaSeleccionada, filledColor);
					dungeonFilled[casillaSeleccionada]=false;
					actualizarCasilla(casillaSeleccionada);
				}
				actualizarCasilla(casillaSeleccionada);
			}
			if(dungeonObject[aider] != 0 && dungeonObject[aider] != null && dungeonObject[aider] != ""){
				if(dungeonObject[aider] < 100){
					switch(dungeonObject[aider]){
						case 1:
							paintDoor();
						break;
						case 2:
							paintSDoor();
						break;
						case 3:
							paintWall();
						break;
						case 4:
							paintTrap();
						break;
						case 5:
							paintColumn();
						break;
						case 6:
							paintWindow();
						break;
					}
				}else{ //Es una dungeon key
					dungeonKey(dungeonObject[aider]-100);
				}
			}
		}
	}
}


// Dibuja la cuadricula
//----------------------------
function drawBoard(){
    for (var x = 0.5; x <= bw; x += 32) {
        contextCasillero.moveTo(x , 0.5);
        contextCasillero.lineTo(x, bh+0.5);
    }

    for (var y = 0.5; y <= bh; y += 32) {
        contextCasillero.moveTo(0.5 , y);
        contextCasillero.lineTo(bw+0.5, y);
    }
    contextCasillero.strokeStyle = gridColor;
    contextCasillero.stroke();
}


// Pinta la casilla en la que esta el cursor
//----------------------------
function markSquare(x, y){

	casillaSeleccionada = getSquarefromCoordinates(x,y);
	pintarCasilla(contextCuadraditos, casillaSeleccionada, gridColor);
}


// Pinta una casilla
// Casilla es un array con coordenadas de casilla
//----------------------------
function pintarCasilla(contexto, casilla, color){
	contexto.fillStyle = color;
	if(!isBorderX() && !isBorderY()){
		var casX = casilla[0]*32;
		var casY = casilla[1]*32;
		contexto.fillRect(casX,casY,32,32);
	}else{
		if(isBorderY()){
			var casX = (casilla[0])*32;
			var casY = (casilla[1]-0.5)*32;
			contexto.fillRect(casX+1.5,casY+30.5,30,5);
		}else{
			var casX = (casilla[0]-0.5)*32;
			var casY = casilla[1]*32;
			contexto.fillRect(casX+30.5,casY+1.5,5,30);
		}
	}

}


// Averigua si es casilla o arista
//----------------------------------------------------
function isBorderX(casilla = casillaSeleccionada){
	if(Math.floor(casilla[0]) - casilla[0] == 0){
		return false;
	}
	return true;
}

function isBorderY(casilla = casillaSeleccionada){
	if(Math.floor(casilla[1]) - casilla[1] == 0){
		return false;
	}
	return true;
}



// Devuelve una casilla recibiendo coordenadas de raton
//----------------------------
function getSquarefromCoordinates(x, y){

	var casX = (x*numCasX)/bw;
	casX = Math.floor(casX);

	var casY = (y*numCasY)/bh;
	casY = Math.floor(casY);

	if(x > (casX*32)+4 && x < (casX*32)+28 && y > (casY*32)+4 && y < (casY*32)+28 && (document.querySelector('input[name="mode"]:checked').value == "wall")){
		return false;
	}

	if(document.querySelector('input[name="mode"]:checked').value == "wall" || document.querySelector('input[name="mode"]:checked').value == "column" || document.querySelector('input[name="mode"]:checked').value == "door" || document.querySelector('input[name="mode"]:checked').value == "sdoor" || document.querySelector('input[name="mode"]:checked').value == "window"){
		if(x > (casX*32)+4 && x < (casX*32)+28 && (y < (casY*32)+7 || y > (casY*32)+25)){
			if(y > (casY*32)+25){
				casY=casY+0.5;
			}else{
				casY=casY-0.5;
			}
		}else{
			if(x < (casX*32)+7){
				casX=casX-0.5;
			}
			if(x > (casX*32)+25){
				casX=casX+0.5;
			}
		}
	}


	casCoords = [casX, casY];

	return casCoords;
}

// Coge las coordenadas del cursor
//----------------------------
cuadraditos.addEventListener("mousemove", function(e) {
	var cRect = cuadraditos.getBoundingClientRect();
	var x = Math.round(e.clientX - cRect.left);
	var y = Math.round(e.clientY - cRect.top);
	contextCuadraditos.clearRect(0, 0, cuadraditos.width, cuadraditos.height);
	if(casillaSeleccionada != getSquarefromCoordinates(x,y) && getSquarefromCoordinates(x,y) != false){
		if(selectedTool == "eraser" && document.querySelector('input[name="subEraser"]:checked').value == "big"){
			markSquare(x-32, y-32);
			markSquare(x-32, y);
			markSquare(x-32, y+32);
			markSquare(x, y-32);
			markSquare(x, y+32);
			markSquare(x+32, y-32);
			markSquare(x+32, y);
			markSquare(x+32, y+32);
			markSquare(x, y);
		}else{
			console.log(casillaSeleccionada);
			markSquare(x, y);
		}
		if(click){
			transformarCasilla();
		}
	}
});


// Registra los clics
//----------------------------
cuadraditos.addEventListener("mousedown", function(e) {
	click = true;
	transformarCasilla();
});

cuadraditos.addEventListener("mouseup", function(e) {
	click = false;
});

cuadraditos.addEventListener("mouseout", function(e) {
	click = false;
});


// Pintar en casilla
//----------------------------
function transformarCasilla(){
	if(document.querySelector('input[name="mode"]:checked').value == "empty" || document.querySelector('input[name="mode"]:checked').value == "fill"){
		if(undoArray.length > 40){
			undoArray.shift();
		}
		if(undoDungeon.length > 20){
			undoDungeon.shift();
		}
		undoDungeon.push({...dungeonFilled});
		undoArray.push(true);
	}else{
		if(undoArray.length > 40){
			undoArray.shift();
		}
		if(undoObjects.length > 20){
			undoObjects.shift();
		}
		undoObjects.push({...dungeonObject});
		undoArray.push(false);
	}
	switch(document.querySelector('input[name="mode"]:checked').value){
		case "empty":
			pintarCasilla(contextDungeon, casillaSeleccionada, emptyColor);
			dungeonFilled[casillaSeleccionada]=true;
			actualizarCasilla(casillaSeleccionada);
		break;

		case "fill":
			pintarCasilla(contextDungeon, casillaSeleccionada, filledColor);
			dungeonFilled[casillaSeleccionada]=false;
			actualizarCasilla(casillaSeleccionada);
		break;

		case "key":
			dungeonKey(parseInt(document.getElementById("dungeonKey").value));
		break;

		case "door":
			actualizarObjeto(casillaSeleccionada,1);
		break;

		case "window":
			paintWindow();
		break;

		case "sdoor":
			actualizarObjeto(casillaSeleccionada,2);
		break;

		case "stair":
			dungeonKey(parseInt(document.getElementById("dungeonKey").value));
		break;

		case "trap":
			paintTrap();
		break;

		case "wall":
			paintWall();
		break;

		case "column":
			paintColumn();
		break;

		case "eraser":
			switch(document.querySelector('input[name="subEraser"]:checked').value){
				case "big":
					bigEraser();
				break;

				case "object":
					objectEraser();
				break;

				case "small":
					smallEraser();
				break;

				case "dungeon":
					dungeonEraser();
				break;
			}
		break;

		case "token":
			paintToken();
		break;

	}
}



// Deshacer
//-------------------------------
function undo(){
	if(undoArray.pop()){
		dungeonFilled = undoDungeon.pop();
	}else{
		dungeonObject = undoObjects.pop();
	}
	cargarDungeon();
}



// Pintar dungeon key en casilla
//-------------------------------
function dungeonKey(dKey){
	contextObject.fillStyle = "black";
	contextObject.font = "18px Arial";
	dungeonObject[casillaSeleccionada] = 100+dKey;
	contextObject.fillText(""+(dungeonObject[casillaSeleccionada]-100), (casillaSeleccionada[0]*32)+11, (casillaSeleccionada[1]*32)+23);
}


// Pintar columna en casilla
//-------------------------------
function paintColumn(){
	if(casillaSeleccionada){
		dungeonObject[casillaSeleccionada] = 5;
		var isNowBorderX = isBorderX();
		var isNowBorderY = isBorderY();
		if(isNowBorderX){
			casillaSeleccionada[0]-=0.5;
		}
		if(isNowBorderY){
			casillaSeleccionada[1]-=0.5;
		}
		var casX = casillaSeleccionada[0]*32;
		var casY = casillaSeleccionada[1]*32;
		contextObject.fillStyle = strokeColor;
		contextObject.beginPath();
		contextObject.lineWidth = 3;
		if(isNowBorderY || isNowBorderX){
			if(isNowBorderY){
				contextObject.arc(casX+16, casY+32, 6, 0, 2 * Math.PI);
			}else{
				contextObject.arc(casX+32, casY+16, 6, 0, 2 * Math.PI);
			}
		}else{
			contextObject.arc(casX+16, casY+16, 6, 0, 2 * Math.PI);
		}
		contextObject.stroke();
		contextObject.closePath();

	}
}


// Pintar trampa o trampilla en casilla
//-------------------------------
function paintTrap(){
	if(casillaSeleccionada){
		dungeonObject[casillaSeleccionada] = 4;
		var isNowBorderX = isBorderX();
		var isNowBorderY = isBorderY();
		if(isNowBorderX){
			casillaSeleccionada[0]-=0.5;
		}
		if(isNowBorderY){
			casillaSeleccionada[1]-=0.5;
		}
		var casX = casillaSeleccionada[0]*32;
		var casY = casillaSeleccionada[1]*32;
		contextObject.fillStyle = strokeColor;
		contextObject.beginPath();
		contextObject.lineWidth = 3;
		if(isNowBorderY || isNowBorderX){
			if(isNowBorderY){
				contextObject.fillRect(casX+8.5, casY+24.5, 15, 15);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+10, casY+26, 12, 12);
			}else{
				contextObject.fillRect(casX+24.5, casY+8.5, 15, 15);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+26, casY+10, 12, 12);
			}
		}else{
				contextObject.fillRect(casX+8.5, casY+8.5, 15, 15);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+10, casY+10, 12, 12);
		}
		contextObject.stroke();
		contextObject.closePath();

	}
}


// Pintar puerta en casilla
//-------------------------------
function paintDoor(){
	if(casillaSeleccionada){
		dungeonObject[casillaSeleccionada] = 1;
		var isNowBorderX = isBorderX();
		var isNowBorderY = isBorderY();
		if(isNowBorderX){
			casillaSeleccionada[0]-=0.5;
		}
		if(isNowBorderY){
			casillaSeleccionada[1]-=0.5;
		}
		var casX = casillaSeleccionada[0]*32;
		var casY = casillaSeleccionada[1]*32;
		contextObject.fillStyle = strokeColor;
		aiderNorte = new Array(casillaSeleccionada[0], casillaSeleccionada[1]-1);
		aiderSur= new Array(casillaSeleccionada[0], casillaSeleccionada[1]+1);
		if(dungeonFilled[aiderSur] == true && dungeonFilled[aiderNorte] == true){
			if(isNowBorderY){
				contextObject.fillRect(casX+5.5,casY+27.5,22,10);
				contextObject.fillRect(casX+0.5,casY+31,30,2);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+7.5,casY+29.5,18,6);
			}else{
				contextObject.fillRect(casX+5.5,casY+11.5,22,10);
				contextObject.fillRect(casX+0.5,casY+15,30,2);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+7.5,casY+13.5,18,6);
			}
		}else{
			if(isNowBorderX){
				contextObject.fillRect(casX+27.5,casY+5.5,10,22);
				contextObject.fillRect(casX+31,casY+2.5,2,30);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+29.5,casY+7.5,6,18);
			}else{
				contextObject.fillRect(casX+11.5,casY+5.5,10,22);
				contextObject.fillRect(casX+15,casY+2.5,2,30);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+13.5,casY+7.5,6,18);
			}
		}

	}
}



// Pintar muro en casilla
//-------------------------------
function paintWall(){
	if(casillaSeleccionada){
		dungeonObject[casillaSeleccionada] = 3;
		var isNowBorderX = isBorderX();
		var isNowBorderY = isBorderY();
		if(isNowBorderX){
			casillaSeleccionada[0]-=0.5;
		}
		if(isNowBorderY){
			casillaSeleccionada[1]-=0.5;
		}
		var casX = casillaSeleccionada[0]*32;
		var casY = casillaSeleccionada[1]*32;
		contextObject.fillStyle = strokeColor;
		if(isNowBorderY){
			contextObject.fillRect(casX+0.5,casY+31,31,2.5);
		}else{
			contextObject.fillRect(casX+31,casY+0.5,2.5,31);
		}

	}
}




// Pintar ventana en casilla
//-------------------------------
function paintWindow(){
	if(casillaSeleccionada){


		dungeonObject[casillaSeleccionada] = 6;
		var isNowBorderX = isBorderX();
		var isNowBorderY = isBorderY();
		if(isNowBorderX){
			casillaSeleccionada[0]-=0.5;
		}
		if(isNowBorderY){
			casillaSeleccionada[1]-=0.5;
		}
		contextObject.strokeStyle = strokeColor;
		var casX = casillaSeleccionada[0]*32;
		var casY = casillaSeleccionada[1]*32;
		if(isNowBorderY || isNowBorderX){
			if(isNowBorderY){
				contextObject.moveTo(casX+0.5,casY+32.5);
				contextObject.lineTo(casX+32.5,casY+32.5);
				contextObject.lineWidth = 1;
				contextObject.stroke();
				contextObject.closePath();

				contextObject.beginPath();
				contextObject.moveTo(casX+0.5,casY+32.5);
				contextObject.lineTo(casX+10.5,casY+32.5);
				contextObject.moveTo(casX+22.5,casY+32.5);
				contextObject.lineTo(casX+32.5,casY+32.5);
				contextObject.lineWidth = 3;
				contextObject.stroke();
			}else{
				contextObject.moveTo(casX+32.5,casY+0.5);
				contextObject.lineTo(casX+32.5,casY+32.5);
				contextObject.lineWidth = 1;
				contextObject.stroke();
				contextObject.closePath();

				contextObject.beginPath();
				contextObject.moveTo(casX+32.5,casY+0.5);
				contextObject.lineTo(casX+32.5,casY+10.5);
				contextObject.moveTo(casX+32.5,casY+22.5);
				contextObject.lineTo(casX+32.5,casY+32.5);
				contextObject.lineWidth = 3;
				contextObject.stroke();
			}
		}else{
			contextObject.beginPath();
			aiderNorte = new Array(casillaSeleccionada[0], casillaSeleccionada[1]-1);
			aiderSur= new Array(casillaSeleccionada[0], casillaSeleccionada[1]+1);
			if(dungeonFilled[aiderSur] != true && dungeonFilled[aiderNorte] != true){
				contextObject.moveTo(casX+16.5,casY);
				contextObject.lineTo(casX+16.5,casY+31.5);
				contextObject.lineWidth = 3;
				contextObject.stroke();
				contextObject.closePath();
			}else{
				contextObject.moveTo(casX,casY+16.5);
				contextObject.lineTo(casX+31.5,casY+16.5);
				contextObject.lineWidth = 3;
				contextObject.stroke();
				contextObject.closePath();
			}
		}


	}
}



// Pintar puerta secreta en casilla
//-------------------------------
function paintSDoor(){
	if(casillaSeleccionada){
		dungeonObject[casillaSeleccionada] = 2;
		contextObject.font = "16px Arial";
		var isNowBorderX = isBorderX();
		var isNowBorderY = isBorderY();
		if(isNowBorderX){
			casillaSeleccionada[0]-=0.5;
		}
		if(isNowBorderY){
			casillaSeleccionada[1]-=0.5;
		}
		var casX = casillaSeleccionada[0]*32;
		var casY = casillaSeleccionada[1]*32;
		contextObject.fillStyle = strokeColor;
		aiderNorte = new Array(casillaSeleccionada[0], casillaSeleccionada[1]-1);
		aiderSur= new Array(casillaSeleccionada[0], casillaSeleccionada[1]+1);
		if(dungeonFilled[aiderSur] == true && dungeonFilled[aiderNorte] == true){
			if(isNowBorderY){
				contextObject.fillRect(casX+0.5,casY+31,30,3);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+10.5,casY+31,12,3);
				contextObject.fillStyle = "black";
				contextObject.fillText("S", casX+11, casY+38);
			}else{
				contextObject.fillRect(casX+0.5,casY+15,30,3);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+10.5,casY+15,12,3);
				contextObject.fillStyle = "black";
				contextObject.fillText("S", casX+11, casY+21.5);
			}
		}else{
			if(isNowBorderX){
				contextObject.fillRect(casX+31,casY+0.5,3,30);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+31,casY+10.5,3,12);
				contextObject.save();
				contextObject.translate(casX+27, casY+22);
				contextObject.rotate(-Math.PI/2);
				contextObject.fillStyle = "black";
				contextObject.fillText("S", 0, 11);
				contextObject.restore();
			}else{
				contextObject.fillRect(casX+15,casY+0.5,3,30);
				contextObject.fillStyle = emptyColor;
				contextObject.fillRect(casX+15,casY+10.5,3,12);
				contextObject.save();
				contextObject.translate(casX+27, casY+22);
				contextObject.rotate(-Math.PI/2);
				contextObject.fillStyle = "black";
				contextObject.fillText("S", 0, -5);
				contextObject.restore();
			}
		}

	}
}


function paintSingleSquare(casilla, corner){
	var coordCasilla = [casilla[0],casilla[1]];
	coordCasilla[0]=(coordCasilla[0]*32);
	coordCasilla[1]=(coordCasilla[1]*32);
	// Paint the selected square
	if(dungeonFilled[casilla]){
		contextDungeon.fillStyle = emptyColor;
	}else{
		contextDungeon.fillStyle = filledColor;
	}
	contextDungeon.fillRect(coordCasilla[0],coordCasilla[1], 32, 32);


	//Pintar intercasillado
	contextDungeon.fillStyle = filledColor;
	// North
	if(( dungeonFilled[new Array(casilla[0], casilla[1]-1)] || dungeonFilled[casilla] ) && casilla[1] != 0 && dungeonFilled[new Array(casilla[0], casilla[1]-1)] == dungeonFilled[casilla] ){
		contextDungeon.fillRect(coordCasilla[0]+6,coordCasilla[1], 20, 1);
	}
	// East
	if(( dungeonFilled[new Array(casilla[0]+1, casilla[1])] || dungeonFilled[casilla] ) && casilla[0] != numCasX && dungeonFilled[new Array(casilla[0]+1, casilla[1])] == dungeonFilled[casilla] ){
		contextDungeon.fillRect(coordCasilla[0]+31,coordCasilla[1]+6, 1, 20);
	}
	// South
	if(( dungeonFilled[new Array(casilla[0], casilla[1]+1)] || dungeonFilled[casilla] ) && casilla[1] != numCasY && dungeonFilled[new Array(casilla[0], casilla[1]+1)] == dungeonFilled[casilla] ){
		contextDungeon.fillRect(coordCasilla[0]+6,coordCasilla[1]+31, 20, 1);
	}
	// West
	if(( dungeonFilled[new Array(casilla[0]-1, casilla[1])] || dungeonFilled[casilla] ) && casilla[0] != 0 && dungeonFilled[new Array(casilla[0]-1, casilla[1])] == dungeonFilled[casilla] ){
		contextDungeon.fillRect(coordCasilla[0],coordCasilla[1]+6, 1, 20);
	}



	// Pintar muros-

	contextDungeon.fillStyle = strokeColor;
	// North
	if(( dungeonFilled[new Array(casilla[0], casilla[1]-1)] || dungeonFilled[casilla] ) && casilla[1] != 0 && dungeonFilled[new Array(casilla[0], casilla[1]-1)] != dungeonFilled[casilla] ){
		contextDungeon.fillRect(coordCasilla[0],coordCasilla[1], 32, 1.5);
	}
	// East
	if(( dungeonFilled[new Array(casilla[0]+1, casilla[1])] || dungeonFilled[casilla] ) && casilla[0] != numCasX && dungeonFilled[new Array(casilla[0]+1, casilla[1])] != dungeonFilled[casilla] ){
		contextDungeon.fillRect(coordCasilla[0]+32-1.5,coordCasilla[1], 1.5, 32);
	}
	// South
	if(( dungeonFilled[new Array(casilla[0], casilla[1]+1)] || dungeonFilled[casilla] ) && casilla[1] != numCasY && dungeonFilled[new Array(casilla[0], casilla[1]+1)] != dungeonFilled[casilla] ){
		contextDungeon.fillRect(coordCasilla[0],coordCasilla[1]+32-1.5, 32, 1.5);
	}
	// West
	if(( dungeonFilled[new Array(casilla[0]-1, casilla[1])] || dungeonFilled[casilla] ) && casilla[0] != 0 && dungeonFilled[new Array(casilla[0]-1, casilla[1])] != dungeonFilled[casilla] ){
		contextDungeon.fillRect(coordCasilla[0],coordCasilla[1], 1.5, 32);
	}


	// Pintar esquinas de muros

	// North-East
	if(casilla[1] != 0 && casilla[0] != numCasX && dungeonFilled[new Array(casilla[0]+1, casilla[1]-1)] != dungeonFilled[casilla]){
		contextDungeon.fillRect(coordCasilla[0]+32-1.5,coordCasilla[1], 1.5, 1.5);
	}
	// South-East
	if(casilla[1] != numCasY && casilla[0] != numCasX && dungeonFilled[new Array(casilla[0]+1, casilla[1]+1)] != dungeonFilled[casilla]){
		contextDungeon.fillRect(coordCasilla[0]+32-1.5,coordCasilla[1]+32-1.5, 1.5, 1.5);
	}
	// South-West
	if(casilla[1] != numCasY && casilla[0] != 0 && dungeonFilled[new Array(casilla[0]-1, casilla[1]+1)] != dungeonFilled[casilla]){
		contextDungeon.fillRect(coordCasilla[0],coordCasilla[1]+32-1.5, 1.5, 1.5);
	}
	// North-West
	if(casilla[1] != 0 && casilla[0] != 0 && dungeonFilled[new Array(casilla[0]-1, casilla[1]-1)] != dungeonFilled[casilla]){
		contextDungeon.fillRect(coordCasilla[0],coordCasilla[1], 1.5, 1.5);
	}
}

function actualizarCasilla(casilla){

	paintSingleSquare(casilla, false);
	paintSingleSquare(new Array(casilla[0]-1, casilla[1]), false);
	paintSingleSquare(new Array(casilla[0], casilla[1]+1), false);
	paintSingleSquare(new Array(casilla[0]+1, casilla[1]), false);
	paintSingleSquare(new Array(casilla[0], casilla[1]-1), false);

	paintSingleSquare(new Array(casilla[0]+1, casilla[1]-1), true);
	paintSingleSquare(new Array(casilla[0]-1, casilla[1]-1), true);
	paintSingleSquare(new Array(casilla[0]+1, casilla[1]+1), true);
	paintSingleSquare(new Array(casilla[0]-1, casilla[1]+1), true);

}

function actualizarObjeto(casilla, objectNum){
	if(dungeonObject[casilla] != 0){
		if(!isBorderX(casilla) && !isBorderY(casilla)){
			var casillasAdyacentes = [
													new Array(casilla[0]-0.5, casilla[1]),
													new Array(casilla[0]+0.5, casilla[1]),
													new Array(casilla[0], casilla[1]+0.5),
													new Array(casilla[0], casilla[1]-0.5)
												];
			contextObject.clearRect(casilla[0]*32, casilla[1]*32, 32, 32);
		}
		if(isBorderX(casilla)){
			var casillasAdyacentes = [
													new Array(casilla[0]-0.5, casilla[1]),
													new Array(casilla[0]+0.5, casilla[1]),
													new Array(casilla[0]+0.5, casilla[1]+0.5),
													new Array(casilla[0]+0.5, casilla[1]-0.5),
													new Array(casilla[0]-0.5, casilla[1]+0.5),
													new Array(casilla[0]-0.5, casilla[1]-0.5)
												];
			contextObject.clearRect(((casilla[0]+0.5)*32)-16, casilla[1]*32, 32, 32);
		}
		if(isBorderY(casilla)){
			var casillasAdyacentes = [
													new Array(casilla[0], casilla[1]+0.5),
													new Array(casilla[0], casilla[1]-0.5),
													new Array(casilla[0]+0.5, casilla[1]+0.5),
													new Array(casilla[0]+0.5, casilla[1]-0.5),
													new Array(casilla[0]-0.5, casilla[1]+0.5),
													new Array(casilla[0]-0.5, casilla[1]-0.5)
												];
			contextObject.clearRect(casilla[0]*32, ((casilla[1]+0.5)*32)-16, 32, 32);
		}

		casillasAdyacentes.forEach((adjCas, i) => {
			pintarObjeto(adjCas);
		});
	}
	dungeonObject[casilla] = objectNum;
	pintarObjeto(casilla);
}

function pintarObjeto(casilla){
	switch(dungeonObject[casilla]){
		case 1: //Door
			contextObject.fillStyle = strokeColor;
			if(isBorderX(casilla) || isBorderY(casilla)){
				if(isBorderX(casilla)){
					contextObject.fillRect((casilla[0]*pxCas)-1.5+16, casilla[1]*pxCas, 3, pxCas);
					contextObject.fillRect((casilla[0]*pxCas)+16-6, casilla[1]*pxCas+5, 12, pxCas-10);
					contextObject.fillStyle = emptyColor;
					contextObject.fillRect((casilla[0]*pxCas)+16-3, casilla[1]*pxCas+8, 6, pxCas-16);
				}else{
					contextObject.fillRect((casilla[0]*pxCas), casilla[1]*pxCas-1.5+16, pxCas, 3);
					contextObject.fillRect((casilla[0]*pxCas)+5, casilla[1]*pxCas+16-6, pxCas-10, 12);
					contextObject.fillStyle = emptyColor;
					contextObject.fillRect((casilla[0]*pxCas)+8, casilla[1]*pxCas+16-3, pxCas-16, 6);
				}
			}else{
				if(dungeonFilled[new Array(casilla[0], casilla[1]-1)] && dungeonFilled[new Array(casilla[0], casilla[1]+1)]){
					contextObject.fillRect((casilla[0]*pxCas)-1.5+16, casilla[1]*pxCas, 3, pxCas);
					contextObject.fillRect((casilla[0]*pxCas)+16-6, casilla[1]*pxCas+5, 12, pxCas-10);
					contextObject.fillStyle = emptyColor;
					contextObject.fillRect((casilla[0]*pxCas)+16-3, casilla[1]*pxCas+8, 6, pxCas-16);
				}else{
					contextObject.fillRect((casilla[0]*pxCas), casilla[1]*pxCas-1.5+16, pxCas, 3);
					contextObject.fillRect((casilla[0]*pxCas)+5, casilla[1]*pxCas+16-6, pxCas-10, 12);
					contextObject.fillStyle = emptyColor;
					contextObject.fillRect((casilla[0]*pxCas)+8, casilla[1]*pxCas+16-3, pxCas-16, 6);
				}
			}
		break;
		case 2:  //Secret Door
			contextObject.fillStyle = strokeColor;
			contextObject.font = "19px Arial bold";
			if(isBorderX(casilla) || isBorderY(casilla)){
				if(isBorderX(casilla)){
					contextObject.fillRect((casilla[0]*pxCas)-1.5+16, casilla[1]*pxCas, 3, (pxCas/2)-5);
					contextObject.fillRect((casilla[0]*pxCas)-1.5+16, (casilla[1]*pxCas)+(pxCas/2)+6, 3, (pxCas/2)-5);

					contextObject.save();
					contextObject.translate(casilla[0]*pxCas, casilla[1]*pxCas);
					contextObject.rotate(-Math.PI/2);
					contextObject.fillText("S", -22, 22);
					contextObject.restore();
				}else{
					contextObject.fillRect((casilla[0]*pxCas), casilla[1]*pxCas-1.5+16, (pxCas/2)-5, 3);
					contextObject.fillRect((casilla[0]*pxCas)+(pxCas/2)+6, casilla[1]*pxCas-1.5+16, (pxCas/2)-5, 3);

					contextObject.fillText("S", casilla[0]*pxCas+11, casilla[1]*pxCas+22);
				}
			}else{
				if(dungeonFilled[new Array(casilla[0], casilla[1]-1)] && dungeonFilled[new Array(casilla[0], casilla[1]+1)]){
					contextObject.fillRect((casilla[0]*pxCas)-1.5+16, casilla[1]*pxCas, 3, (pxCas/2)-5);
					contextObject.fillRect((casilla[0]*pxCas)-1.5+16, (casilla[1]*pxCas)+(pxCas/2)+6, 3, (pxCas/2)-5);

					contextObject.save();
					contextObject.translate(casilla[0]*pxCas, casilla[1]*pxCas);
					contextObject.rotate(-Math.PI/2);
					contextObject.fillText("S", -22, 22);
					contextObject.restore();
				}else{
					contextObject.fillRect((casilla[0]*pxCas), casilla[1]*pxCas-1.5+16, (pxCas/2)-5, 3);
					contextObject.fillRect((casilla[0]*pxCas)+(pxCas/2)+6, casilla[1]*pxCas-1.5+16, (pxCas/2)-5, 3);

					contextObject.fillText("S", casilla[0]*pxCas+11, casilla[1]*pxCas+22);
				}
			}
		break;
		case 3:

		break;
		case 4:

		break;
		case 5:

		break;
		case 6:

		break;
		case 7:

		break;
		case 8:

		break;
	}
}


// Dungeon eraser
// ------------------------
function dungeonEraser(){

	dungeonFilled[casillaSeleccionada] = false;
	actualizarCasilla(casillaSeleccionada);

}




// Small eraser
// ------------------------
function smallEraser(){

	var squares = [casillaSeleccionada];
	dungeonEraser();


	squares.push(new Array(casillaSeleccionada[0]-0.5, casillaSeleccionada[1]));
	squares.push(new Array(casillaSeleccionada[0]+0.5, casillaSeleccionada[1]));
	squares.push(new Array(casillaSeleccionada[0], casillaSeleccionada[1]-0.5));
	squares.push(new Array(casillaSeleccionada[0], casillaSeleccionada[1]+0.5));

	squares.forEach((square, i) => {
		actualizarObjeto(square, 0);
	});

}


// Big eraser
// ------------------------
function bigEraser(){

	var squares = [casillaSeleccionada];
	if(casillaSeleccionada[1] != 0){
		squares.push(new Array(casillaSeleccionada[0], casillaSeleccionada[1]-1));
		if(casillaSeleccionada[0] != 0){
			squares.push(new Array(casillaSeleccionada[0]-1, casillaSeleccionada[1]-1));
		}
		if(casillaSeleccionada[0] != numCasX){
			squares.push(new Array(casillaSeleccionada[0]+1, casillaSeleccionada[1]-1));
		}
	}
	if(casillaSeleccionada[1] != numCasY){
		squares.push(new Array(casillaSeleccionada[0], casillaSeleccionada[1]+1));
		if(casillaSeleccionada[0] != 0){
			squares.push(new Array(casillaSeleccionada[0]-1, casillaSeleccionada[1]+1));
		}
		if(casillaSeleccionada[0] != numCasX){
			squares.push(new Array(casillaSeleccionada[0]+1, casillaSeleccionada[1]+1));
		}
	}
	if(casillaSeleccionada[0] != 0){
		squares.push(new Array(casillaSeleccionada[0]-1, casillaSeleccionada[1]));
	}
	if(casillaSeleccionada[0] != numCasX){
		squares.push(new Array(casillaSeleccionada[0]+1, casillaSeleccionada[1]));
	}

	squares.forEach((square, i) => {
		casillaSeleccionada = square;
		smallEraser();
	});

}



// Object eraser
// ------------------------
function objectEraser(){

	actualizarObjeto(casillaSeleccionada, 0);

}


// Exporter
//--------------------------
function exporter(){
	let filled = JSON.stringify(dungeonFilled);
	let objects = JSON.stringify(dungeonObject);
	var textToSave = filled+"----------"+objects;

	var hiddenElement = document.createElement('a');

	hiddenElement.href = 'data:attachment/text,' + encodeURI(textToSave);
	hiddenElement.target = '_blank';
	hiddenElement.download = 'donjson.txt';
	hiddenElement.click();
}

// Importer
//----------------------------------
function importerButton(){

	let input = document.createElement('input');
    input.type = 'file';
    input.onchange = _this => {
              let files =   Array.from(input.files);
              importer(files[0]);
          };
	input.click();
}

function importer(file){

	const reader = new FileReader();

	reader.addEventListener("load", () => {
		// this will then display a text file
		dungeonFilled = JSON.parse(reader.result.split('----------')[0]);
		dungeonObject = JSON.parse(reader.result.split('----------')[1]);
		cargarDungeon();
	}, false);

	if (file) {
		reader.readAsText(file);
	}


}


// Boton de descarga
//------------------------
function download(){

	  var link = document.createElement('a');
	  link.download = 'dungeon.png';
	  link.href = document.getElementById('dungeon').toDataURL()
	  link.click();

}



// Change colors functions
//-------------------------

function changeBColor(){
	backgroundColor = document.getElementById("backgroundColor").value
	document.getElementById("backgroundColor").style.border="3px solid "+backgroundColor
}

function changeGColor(){
	gridColor = document.getElementById("gridColor").value
	document.getElementById("gridColor").style.border="3px solid "+gridColor
}

function changeFColor(){
	filledColor = document.getElementById("filledColor").value
	document.getElementById("filledColor").style.border="3px solid "+filledColor
}

function changeEColor(){
	emptyColor = document.getElementById("emptyColor").value
	document.getElementById("emptyColor").style.border="3px solid "+emptyColor
}

function changeSColor(){
	strokeColor = document.getElementById("strokeColor").value
	document.getElementById("strokeColor").style.border="3px solid "+strokeColor
}

function ToggleGrid(){
	if(document.getElementById("casillero").style.display=="none"){
		document.getElementById("casillero").style.display="inherit";
	}else{
		document.getElementById("casillero").style.display="none";
	}
}

function ToggleGridLines(){
	showGridLine = !showGridLine;
	cargarDungeon();
}



function claveDungeon(){
	radioChanger = 2;
}



// Hotkeys
//-----------------------------
function KeyPress(e) {
    var evtobj = window.event? event : e
    if (evtobj.keyCode == 90 && evtobj.ctrlKey){
		e.preventDefault();
		undo();
	}
}

document.onkeydown = KeyPress;

function paintToken(){
	var token = tokens[parseInt(document.querySelector('input[name="tokens"]:checked').value)]
	if(token.active){
		contextToken.clearRect((token.casilla[0]*32), (token.casilla[1]*32), 32, 32);
	}
	token.casilla = casillaSeleccionada;
	token.active = true;
	token.name = document.getElementById("t"+document.querySelector('input[name="tokens"]:checked').value+"T").value;
	contextToken.beginPath();
	contextToken.fillStyle = token.color;
	contextToken.strokeStyle = token.color;
	contextToken.lineWidth = 4;
	contextToken.arc((casillaSeleccionada[0]*32)+16, (casillaSeleccionada[1]*32)+16, 14, 0, 2 * Math.PI);
	contextToken.stroke();
	contextToken.font = "21px Arial bold";
	contextToken.fillText(token.name, (casillaSeleccionada[0]*32)+8, (casillaSeleccionada[1]*32)+23);
	contextToken.closePath();
}

function changeTool(tool){
	selectedTool = tool;
	console.log(tool);
	if(tool == "token"){
		document.getElementById("subTokens").style.display="inherit";
	}else{
		document.getElementById("subTokens").style.display="none";
	}

	if(tool == "eraser"){
		document.getElementById("subEraser").style.display="inherit";
	}else{
		document.getElementById("subEraser").style.display="none";
	}
}


//TODO: Hacer que Undo no bugee al arrastrar
//TODO: Herramienta de borrado de objetos
						//TODO: Herramienta de borrado de 3x3
//TODO: Afilar el sistema de trazados <--
						//TODO: Paint background on start
//TODO: Pintar escaleras
//TODO: Pulir pintado de textos
//TODO: Borrar objetos cuando pintas otro encima
//TODO: Copiar y pegar y decidir trabajo multiplanta
//TODO: Default color styles
						//TODO: Tokens?
//TODO:

/*
	En dungeon layer:
		Cada casilla tiene 32 px, el muro es de 1.5px y la separacion 0.5. El muro es si la adyacente es distinta
	En object layer:

*/

drawBoard();
</script>
